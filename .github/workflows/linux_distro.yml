name: CI y Pruebas Funcionales en Linux

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Permite ejecutar manualmente
  workflow_dispatch: 

jobs:
  
  run-ci-tests:
    name: üß™ CI y Pruebas Unitarias
    uses: ./.github/workflows/rust.yml
    
    # -----------------------------------------------------

  testing-functional:
    name: üîé Pruebas Funcionales (Linux)
    runs-on: ubuntu-latest
    
    needs: run-ci-tests
    
    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Instalar Rust (Stable)
        # Usamos 'dtolnay/rust-toolchain' para un manejo m√°s eficiente
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable 

      - name: üî® Compilar Binario (Release)
        # Este paso compila y produce el ejecutable optimizado
        run: |
            cargo build --release
      
      - name: üß™ Ejecutar Pruebas Funcionales del Binario
        run: |
            echo "This is a test file for int64grep.\nEsta segunda linea" > testfile.txt
            
            EXECUTABLE="./target/release/int64grep"
            
            echo "--- Verificando busqueda 1 ---"
            OUTPUT_1=$("$EXECUTABLE" "test" testfile.txt)
            if [[ "$OUTPUT_1" != *"This is a test file for int64grep."* ]]; then
              echo "‚ùå Error: La salida no contiene la l√≠nea esperada (test)."
              echo "Salida obtenida: $OUTPUT_1"
              exit 1
            fi
            echo "‚úÖ Prueba 1 exitosa."

            # --- Prueba 2: Buscar "segunda" ---
            echo "--- Verificando busqueda 2 ---"
            OUTPUT_2=$("$EXECUTABLE" "segunda" testfile.txt)
            if [[ "$OUTPUT_2" != *"Esta segunda linea"* ]]; then
              echo "‚ùå Error: La salida no contiene la l√≠nea esperada (segunda)."
              echo "Salida obtenida: $OUTPUT_2"
              exit 1
            fi
            echo "‚úÖ Prueba 2 exitosa."